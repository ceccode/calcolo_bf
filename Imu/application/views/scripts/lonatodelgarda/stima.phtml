<?php
$values                = $this->values;
$capacita_edificatoria = $this->capacita_edificatoria;

$lonato_u_destammesse = Factory_dbTable::getClass("lonato", "u_destammesse");
$stmt5 = $lonato_u_destammesse->filtroDestinazioniAmmesse($values['id_m_ambiti']);
$this->headTitle("Calcolo imu lonato");
?>
<div id="risultati_calcolo_stima">
    
<!-- stima -->
<table style="font-size: 12px;" class="left">
    <tr class="odd">
        <td>Capacità edificatoria calcolata</td>
        <td><?=$capacita_edificatoria?></td>
        <td>(m3)</td>
    </tr>
    <tr>
        <td>Valore area calcolata</td>
        <td>123</td> 
        <td>(Euro/m3)</td>        
    </tr>
    <tr class="odd">
        <td>Valore area edificabile</td>
        <td>69.000</td> 
        <td>(Euro/m3)</td>        
    </tr>    
</table>
    <!-- indici -->
    <table style="float:left; margin-bottom: 10px; margin-left: 170px;">
        <tr class="odd">
            <td>Incidenza viabilità</td>
            <td>0,3</td> 
            <td></td>
        </tr>
        <tr class="">
            <td>Capacità edific. pred. o prees.</td>
            <td>0,3</td>
            <td></td>
        </tr>        
        <tr class="odd">
            <td>Indice fondario</td>
            <td>0,3</td> 
            <td>(volume in m3/m2)</td>
        </tr>
        <tr>
            <td>Incremento lotti saturi</td>
            <td>45</td>
            <td>(% di volume da indice)</td>
        </tr>    
        <tr class="odd">
            <td>Indice territoriale</td>
            <td>0,5</td>
            <td>(volume in m3/m2)</td>
        </tr>
        <tr>
            <td>Volume preesistente</td>
            <td>150</td>
            <td>(volume in m3)</td>
        </tr>
        <tr class="odd">
            <td>Volume incremento</td>
            <td>30</td>
            <td>(volume in m3)</td>
        </tr>
        <tr>
            <td>Volume predefinito</td>
            <td>50</td>  
            <td>(volume in m3)</td>
        </tr>
        <tr class="odd">
            <td>Indice fondario aggiuntivo</td>
            <td>0.6</td>
            <td>(volume in m3/m2)</td>
        </tr>    
    </table>
</div> 
<div id="div_form_2" class="border_destra border_sotto border_sopra border-sinistra"> <!-- div con i dati form 2 -->
    <div class="left copri_tabella2 border_destra"> <!-- colonna1 -->
        <div id="header_destinazione_uso" class="border_sotto grigio">Destinazione d'uso ammessa</div>
        <div id="corpo_destinazione_uso">
            <?php foreach ($stmt5 as $chiave => $valore): ?>
                <div class="blocco_tabella2"><?= $valore['descrizione'] ?></div>
            <?php endforeach; ?>
        </div>
    </div>

    <div class="left copri_tabella2 border_destra"> <!-- colonna2 -->
        <div id="header_quota_massima_ammissibile" class="border_sotto  grigio">Quota massima ammissibile</div>
        <div id="corpo_quota_massima_ammissibile" >
            <?php foreach ($stmt5 as $chiave => $valore): ?>
                <div id="quota-<?= $valore["id_u_destammesse"] ?>" class="blocco_tabella2"><?= $valore['quota_massima_ammissibile'] ?></div>
            <?php endforeach; ?>
        </div>
    </div>

    <div class="left copri_tabella2 border_destra"> <!-- colonna3 -->
        <div id="header_soglia_dimensione_massima" class="border_sotto  grigio">Soglia dimensione massima</div>
        <div id="corpo_soglia_dimensione_massima">
            <?php foreach ($stmt5 as $chiave => $valore): ?>
                <div class="blocco_tabella2"><?= $valore['soglia_dimensione_massima'] ?></div>
            <?php endforeach; ?>
        </div>
    </div>

    <div class="left copri_tabella2 border_destra"> <!-- colonna4 -->
        <div id="header_peso_standard" class="border_sotto  grigio">Peso standard della destinazione</div>
        <div id="corpo_peso_standard">
            <?php foreach ($stmt5 as $chiave => $valore): ?>
                <div class="blocco_tabella2"><?= $valore['quota_percentuale'] ?></div>
            <?php endforeach; ?>
        </div>
    </div>

    <div class="left copri_tabella2"> <!-- colonna5 -->
        <div id="header_quota_progetto" class="border_sotto grigio">Quota di progetto</div>
        <div id="corpo_quota_progetto">
            <?= $this->form; ?>
        </div>
    </div>
</div>
<div style="clear:both"></div>
<a class="button doc-button" href="<?=
$this->url(array('controller' => 'Lonatodelgarda',
    'action' => 'index'), null, TRUE);
?>">Ricalcola</a>
<script type="text/javascript">
$(function()
{
    $("#capacita_edificatoria").blur(function(){
        //alert($(this).parent().prev().find('label').attr('for'));
        var id = $(this);
        if(id.val()==''){
           $("#submit").attr("disabled", "true");
        }else {
           $("#submit").removeAttr("disabled");
        }
        
        doValidation(id);
               
        });
      

    function doValidation(id){
        var url = '/public/Lonatodelgarda/validate-form';
        var data = {};
        data[id.attr('name')] = id.val();

        $.post(url,data,function(resp){

            var id2 = id.attr('name');
            $("#"+id2).after(getErrorHtml(resp[id2],id2));
            //getErrorHtml(resp[id2]),id2
            
        },'json');
    }

    function getErrorHtml(formsError, id){
        var o = '<ul id="errors-'+id+'" class="errors">';
        for(errorKeys in formsError)
        {
            o += '<li>'+formsError[errorKeys]+'</li>';
        }
        o += '</ul>';
        return o;
    }
    
    
});
</script>

